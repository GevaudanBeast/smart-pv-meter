name: Release SPVM

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (ex: 0.5.1)"
        required: true
        type: string
      prerelease:
        description: "Marquer comme pré-release ?"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      INTEGRATION_DIR: custom_components/spvm
      ZIP_PREFIX: smart-pv-meter
      REPO_NAME: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Vérif inputs
        id: meta
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version invalide: $VERSION (attendu: X.Y.Z)"; exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "prerelease=${{ inputs.prerelease }}" >> "$GITHUB_OUTPUT"

      - name: Installer jq & zip
        run: sudo apt-get update && sudo apt-get install -y jq zip

      - name: Mettre à jour manifest.json (+ hacs.json si présent)
        run: |
          set -e
          VERSION="${{ steps.meta.outputs.version }}"

          MANIFEST="$INTEGRATION_DIR/manifest.json"
          if [ ! -f "$MANIFEST" ]; then
            echo "Fichier manquant: $MANIFEST"; exit 1
          fi

          # -- MAJ manifest.json: "version"
          tmp="$(mktemp)"
          jq --arg v "$VERSION" '.version = $v' "$MANIFEST" > "$tmp" && mv "$tmp" "$MANIFEST"

          echo "manifest.json après MAJ:"
          cat "$MANIFEST"

          # -- MAJ hacs.json optionnelle: zip_release + filename versionné
          if [ -f "hacs.json" ]; then
            tmp="$(mktemp)"
            # Si le fichier n’a pas ces champs, on les ajoute
            jq --arg fn "${ZIP_PREFIX}-v${VERSION}.zip" '
              .zip_release = true
              | .filename = $fn
              | .render_readme = (has("render_readme") and .render_readme) or true
              ' hacs.json > "$tmp" && mv "$tmp" hacs.json

            echo "hacs.json après MAJ:"
            cat hacs.json
          fi

      - name: Commit des fichiers versionnés
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): v${VERSION}"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "Pas de modifications à committer."
          fi

      - name: Créer/Mettre à jour le tag
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          git tag -f "v${VERSION}" || true
          git push -f origin "v${VERSION}"

      - name: Construire l’archive ZIP pour HACS (optionnel)
        run: |
          set -e
          VERSION="${{ steps.meta.outputs.version }}"

          ZIP_NAME="${ZIP_PREFIX}-v${VERSION}.zip"

          # On zippe par défaut le dossier d’intégration + fichiers utiles
          # HACS attend que l’archive contienne l’arbo "custom_components/spvm/**"
          zip -r "$ZIP_NAME" \
            custom_components/spvm \
            README.md LICENSE \
            hacs.json hacs/ hacs.png hacs.svg 2>/dev/null || true

          ls -lh "$ZIP_NAME" || true
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Créer la Release GitHub
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.meta.outputs.version }}
          name: Smart PV Meter v${{ steps.meta.outputs.version }}
          draft: false
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: |
            ${{ env.ZIP_NAME }}
